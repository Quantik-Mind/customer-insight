name: Quantik Mind ‚Äì Customer Insight

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  decision-intelligence:
    name: Quantik Mind ‚Äì Decision Intelligence
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Functional Selection
      # ------------------------------------------------------------
      - name: Call Quantik Mind ‚Äì Functional Selection
        env:
          API_URL: ${{ secrets.QUANTIK_API_URL }}
          TOKEN: ${{ secrets.QUANTIK_API_TOKEN }}
          PROJECT_ID: ${{ secrets.QUANTIK_PROJECT_ID }}
        run: |
          set -e

          echo ""
          echo "============================================"
          echo "üß† Quantik Mind ‚Äì Test Selection Intelligence"
          echo "============================================"
          echo ""

          curl -sS -X GET \
            "$API_URL/functional/select?project_id=$PROJECT_ID&lookback_commits_hours=24" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/json" \
            -o select.json

          jq empty select.json

          RUN_ID=$(jq -r '.run_id' select.json)

          echo "üéØ Test Selection Results"
          echo "--------------------------------------------"
          echo "‚Ä¢ Total tests     : $(jq -r '.counts.total' select.json)"
          echo "‚Ä¢ Selected tests  : $(jq -r '.counts.selected' select.json)"
          echo "‚Ä¢ Reduction       : $(jq -r '.reduction_percentage' select.json)%"
          echo ""

          echo ""
          echo "‚úÖ Selected Tests"
          echo "--------------------------------------------"
          jq -r '.selected[] | .test_name' select.json | nl -w2 -s'. '
          echo "
            
          echo "üì¶ Commit Awareness"
          echo "--------------------------------------------"
          echo "‚Ä¢ Enabled         : $(jq -r '.commit_consideration.enabled' select.json)"
          echo "‚Ä¢ Affected tests  : $(jq -r '.commit_consideration.affected_tests' select.json)"
          echo ""

          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # Decision Insight
      # ------------------------------------------------------------
      - name: Call Quantik Mind ‚Äì Decision Insight
        env:
          API_URL: ${{ secrets.QUANTIK_API_URL }}
          TOKEN: ${{ secrets.QUANTIK_API_TOKEN }}
        run: |
          set -e

          echo ""
          echo "============================================"
          echo "üìà Quantik Mind ‚Äì Decision Insight"
          echo "============================================"
          echo ""

          curl -sS -X GET \
            "$API_URL/functional/runs/$RUN_ID/decision-insight" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/json" \
            -o insight.json

          jq empty insight.json

          echo "üß¨ Quantum Distribution"
          echo "--------------------------------------------"
          echo "‚Ä¢ Superposition   : $(jq -r '.quantum.distribution.superposition' insight.json)"
          echo "‚Ä¢ Entanglement    : $(jq -r '.quantum.distribution.entanglement' insight.json)"
          echo "‚Ä¢ Uncertainty     : $(jq -r '.quantum.distribution.uncertainty' insight.json)"
          echo ""

          echo "üõ°Ô∏è Risk Coverage"
          echo "--------------------------------------------"
          echo "‚Ä¢ Risk Coverage   : $(jq -r '.risk.coverage_percentage' insight.json)%"
          echo "‚Ä¢ Risk Efficiency : $(jq -r '.risk.efficiency' insight.json)x"
          echo "‚Ä¢ Top-25% Risk    : $(jq -r '.risk.top25_share' insight.json)%"
          echo ""

          echo "üü¢ Always-Green"
          echo "--------------------------------------------"
          echo "‚Ä¢ Avoided tests   : $(jq -r '.always_green.avoided' insight.json)"
          echo ""

          echo "‚úÖ Quantik Mind decision completed successfully"
          echo ""

      # ------------------------------------------------------------
      # Save Artifacts
      # ------------------------------------------------------------
      - name: Upload Decision Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quantik-decision
          path: |
            select.json
            insight.json
          retention-days: 30
