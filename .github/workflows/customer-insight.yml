name: Quantik Mind â€“ Customer Insight

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  decision-intelligence:
    name: Quantik Mind â€“ Decision Intelligence
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Functional Selection
      # ------------------------------------------------------------
      - name: Call Quantik Mind â€“ Functional Selection
        env:
          API_URL: ${{ secrets.QUANTIK_API_URL }}
          TOKEN: ${{ secrets.QUANTIK_API_TOKEN }}
          PROJECT_ID: ${{ secrets.QUANTIK_PROJECT_ID }}
        run: |
          set -e

          echo ""
          echo "============================================"
          echo "ðŸ§  Quantik Mind â€“ Functional Decision"
          echo "============================================"
          echo ""

          curl -sS -X GET \
            "$API_URL/functional/select?project_id=$PROJECT_ID&lookback_commits_hours=24" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/json" \
            -o select.json

          jq empty select.json

          RUN_ID=$(jq -r '.run_id' select.json)

          echo "ðŸ“Š Test Selection"
          echo "--------------------------------------------"
          echo "â€¢ Total tests     : $(jq -r '.counts.total' select.json)"
          echo "â€¢ Selected tests  : $(jq -r '.counts.selected' select.json)"
          echo "â€¢ Reduction       : $(jq -r '.reduction_percentage' select.json)%"
          echo ""

          echo "ðŸ§  Commit Awareness"
          echo "--------------------------------------------"
          echo "â€¢ Enabled         : $(jq -r '.commit_consideration.enabled' select.json)"
          echo "â€¢ Affected tests  : $(jq -r '.commit_consideration.affected_tests' select.json)"
          echo ""

          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV

      # ------------------------------------------------------------
      # Decision Insight
      # ------------------------------------------------------------
      - name: Call Quantik Mind â€“ Decision Insight
        env:
          API_URL: ${{ secrets.QUANTIK_API_URL }}
          TOKEN: ${{ secrets.QUANTIK_API_TOKEN }}
        run: |
          set -e

          echo ""
          echo "============================================"
          echo "ðŸ“ˆ Quantik Mind â€“ Decision Insight"
          echo "============================================"
          echo ""

          curl -sS -X GET \
            "$API_URL/functional/runs/$RUN_ID/decision-insight" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Accept: application/json" \
            -o insight.json

          jq empty insight.json

          echo "ðŸ§¬ Quantum Distribution"
          echo "--------------------------------------------"
          echo "â€¢ Superposition   : $(jq -r '.quantum.distribution.superposition' insight.json)"
          echo "â€¢ Entanglement    : $(jq -r '.quantum.distribution.entanglement' insight.json)"
          echo "â€¢ Uncertainty     : $(jq -r '.quantum.distribution.uncertainty' insight.json)"
          echo ""

          echo "ðŸ’¾ Risk Coverage"
          echo "--------------------------------------------"
          echo "â€¢ Risk Coverage   : $(jq -r '.risk.coverage_percentage' insight.json)%"
          echo "â€¢ Risk Efficiency : $(jq -r '.risk.efficiency' insight.json)x"
          echo "â€¢ Top-25% Risk    : $(jq -r '.risk.top25_share' insight.json)%"
          echo ""

          echo "ðŸŒ± Always-Green"
          echo "--------------------------------------------"
          echo "â€¢ Avoided tests   : $(jq -r '.always_green.avoided' insight.json)"
          echo ""

          echo "âœ… Quantik Mind decision completed successfully"
          echo ""

      # ------------------------------------------------------------
      # Save Artifacts
      # ------------------------------------------------------------
      - name: Upload Decision Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quantik-decision
          path: |
            select.json
            insight.json
          retention-days: 30
