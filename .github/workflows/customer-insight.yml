name: Quantik Mind ‚Äì Customer Insight

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  decision-intelligence:
    name: Quantik Mind ‚Äì Decision Intelligence
    runs-on: ubuntu-latest
    
    steps:
      # ------------------------------------------------------------
      # Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Call Quantik Mind API
      # ------------------------------------------------------------
      - name: Call Quantik Mind ‚Äì Functional Selection
        env:
          API_URL: ${{ secrets.QUANTIK_API_URL }}
          TOKEN: ${{ secrets.QUANTIK_API_TOKEN }}
          PROJECT_ID: ${{ secrets.QUANTIK_PROJECT_ID }}
        run: |
          set +e  # Don't exit on error
          
          echo "üîç Calling Quantik Mind API..."
          echo "URL: $API_URL/functional/select"
          echo "Project: $PROJECT_ID"
          echo ""
          
          # ‚úÖ GET request con tutti gli header necessari
          HTTP_CODE=$(curl -sS -L -X GET \
            "$API_URL/functional/select?project_id=$PROJECT_ID&lookback_commits_hours=24" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -o response.json \
            -w "%{http_code}")
          
          echo "============================================"
          echo "üìä HTTP Status: $HTTP_CODE"
          echo "============================================"
          echo ""
          
          # Verifica status code
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ API call successful"
          else
            echo "‚ùå API call failed with status $HTTP_CODE"
            echo ""
            echo "Response body:"
            cat response.json 2>/dev/null || echo "(empty response)"
            exit 1
          fi
          
          # Verifica JSON valido
          if jq empty response.json >/dev/null 2>&1; then
            echo "‚úÖ Response is valid JSON"
          else
            echo "‚ö†Ô∏è Response is NOT valid JSON"
            cat response.json
            exit 1
          fi
          
          echo ""

      # ------------------------------------------------------------
      # Decision Intelligence Summary
      # ------------------------------------------------------------
      - name: Quantik Mind ‚Äì Decision Intelligence Summary
        if: success()  # ‚úÖ Esegui solo se la chiamata API ha successo
        run: |
          echo ""
          echo "============================================"
          echo "üß† Quantik Mind ‚Äì Functional Decision Summary"
          echo "============================================"
          echo ""
          
          TOTAL=$(jq -r '.counts.total // "N/A"' response.json)
          SELECTED=$(jq -r '.counts.selected // "N/A"' response.json)
          REDUCTION=$(jq -r '.reduction_percentage // "N/A"' response.json)
          TAU=$(jq -r '.tau // "N/A"' response.json)
          
          echo "üìä Test Selection"
          echo "--------------------------------------------"
          echo "‚Ä¢ Total tests     : $TOTAL"
          echo "‚Ä¢ Selected tests  : $SELECTED"
          echo "‚Ä¢ Reduction       : ${REDUCTION}%"
          echo ""
          
          echo "üß¨ Quantum Distribution"
          echo "--------------------------------------------"
          echo "‚Ä¢ Decision Tau    : $TAU"
          
          # ‚úÖ Estrai quantum distribution
          SUPER=$(jq -r '.impact_snapshot.quantum_distribution.superposition // 0' response.json)
          ENT=$(jq -r '.impact_snapshot.quantum_distribution.entanglement // 0' response.json)
          UNC=$(jq -r '.impact_snapshot.quantum_distribution.uncertainty // 0' response.json)
          
          echo "‚Ä¢ Superposition   : $SUPER"
          echo "‚Ä¢ Entanglement    : $ENT"
          echo "‚Ä¢ Uncertainty     : $UNC"
          echo ""
          
          echo "üß† Commit Awareness"
          echo "--------------------------------------------"
          COMMIT_ENABLED=$(jq -r '.commit_consideration.enabled // false' response.json)
          COMMIT_AFFECTED=$(jq -r '.commit_consideration.affected_tests // 0' response.json)
          
          echo "‚Ä¢ Enabled         : $COMMIT_ENABLED"
          echo "‚Ä¢ Affected tests  : $COMMIT_AFFECTED"
          echo ""
          
          echo "üíæ Risk Coverage"
          echo "--------------------------------------------"
          RISK_COV=$(jq -r '.impact_snapshot.kpis.risk_coverage // "N/A"' response.json)
          RISK_EFF=$(jq -r '.impact_snapshot.kpis.risk_efficiency // "N/A"' response.json)
          
          echo "‚Ä¢ Risk Coverage   : ${RISK_COV}%"
          echo "‚Ä¢ Risk Efficiency : ${RISK_EFF}x"
          echo ""
          
          echo "‚úÖ Quantik Mind decision completed successfully"
          echo ""

      # ------------------------------------------------------------
      # Save Artifact (optional)
      # ------------------------------------------------------------
      - name: Upload Response Artifact
        if: always()  # ‚úÖ Salva sempre, anche in caso di errore
        uses: actions/upload-artifact@v4
        with:
          name: quantik-selection-response
          path: response.json
          retention-days: 30
